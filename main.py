#######################################################################################################
##                                                                                                   ##
##  88888888ba  88888888888 88888888ba,       ad88888ba        db        888b      88 88888888ba,    ##
##  88      "8b 88          88      `"8b     d8"     "8b      d88b       8888b     88 88      `"8b   ##
##  88      ,8P 88          88        `8b    Y8,             d8'`8b      88 `8b    88 88        `8b  ##
##  88aaaaaa8P' 88aaaaa     88         88    `Y8aaaaa,      d8'  `8b     88  `8b   88 88         88  ##
##  88""""88'   88"""""     88         88      `"""""8b,   d8YaaaaY8b    88   `8b  88 88         88  ##
##  88    `8b   88          88         8P            `8b  d8""""""""8b   88    `8b 88 88         8P  ##
##  88     `8b  88          88      .a8P     Y8a     a8P d8'        `8b  88     `8888 88      .a8P   ##
##  88      `8b 88888888888 88888888Y"'       "Y88888P" d8'          `8b 88      `888 88888888Y"'    ##
##                                                              .                                    ##
##	       *                .                                                    .                   ##
##                                        +-+-+-+-+-+-+-+                                     .      ##
##                                        |V| |0|.|0|.|1|              .                             ##
##                  *                     +-+-+-+-+-+-+-+                                            ##
##	    .                        ,                                                   *               ##
##                ,                                                                                  ##
##                         STRATEGIC ROGUELIKE ACTION AT THE END OF TIME                             ##
##                                  A GAME BY DOG IDIOT, 2020                                        ##
##           .         .                                                      *             .        ##
##                                 .            .                   .                .               ##
##                                                         ,                                         ##
##                            .                                                                      ##
##     *                      ;           .                               .                          ##
##                        - --+- -                             +                                +    ##
##                 .          !              *       .                               .               ##
##              .             .                                      .                               ##
##                                       .                                                           ##
##                .                                            .             .              +        ##
##     *   .                  .              .        .   *          .             .                 ##
##  .         .                     .       .           .      .        .    .        .           ,  ##
##          .     *           .                    .             .             .          ,,         ##
##                                 .                         .                                       ##
##____^/\___^--____/\___________________/\/\---/\___________---______________________________________##
##   /\^   ^  ^    ^                  ^^ ^  '\ ^          ^       ---           ---                  ##
##         --           -            --  -      -         ---  __       ^    __       ^      __      ##
##   --  __                      ___--  ^  ^                         --  ___        --  ___          ##
##                ____                                                                               ##
##                                                                                                   ##
##      _______________________________________________________________________________________      ##
##     |                                                                                       |     ##
##     |   The past, gone. The future, dead.                                                   |     ##
##     |                                                                                       |     ##
##     |   A  world  that has  ended  too  many times  faces the final  descent into entropy.  |     ##                                
##     |   As unfeeling,  unthinking, uncaring  chaos  grows  to consumes  existence  itself,  |     ##
##     |   scattered remnants of sentience  roam  the wasteland, haunted  by incomprehensible  |     ##
##     |   loneliness  and  endless grief. Some  seek death;   some seek meaning.  Some cling  |     ##
##     |   to life in child-like defiance.                                                     |     ##
##     |                                                                                       |     ##
##	   |   Through  the  veil of despair, a lone star shines - drawing the eyes of a wanderer  |     ##
##     |   who has forgotten his  name long, long ago.  It is decided that he must follow it,  |     ##
##     |   though he does not know why.  What awaits him, he doesn't know either;  be it  his  |     ##
##	   |   end, be it the end of all... he must see it through.                                |     ##
##	   |_______________________________________________________________________________________|     ##
##                                                                                                   ##
##                                                                                                   ##
##     ....       ..      ..                           .;:::::;.   .'::::;.                          ##
##    .,,,'     ....  ...','.   ...,oxdo::odl:lxxxdxxxxOKXXOOKXOxxxk0XXXXXOl;:lc. ...:dxxxxo,.       ##
##    ,:,.. .''','. .';,.....   .,,,,;;'..,;,,,;;;;;;;;;;::..:dkkkOKXXXXXXXXx;dKo.;cdKKOkkkO0x'      ##
##.,..';.   .;:lolld0K0xc;.    .............  ..,:cccc,.....      .cdodOXXXXk;dXd,ldxkdoc::lOk,      ##
##    .''..   .ck0KXXXXXNKx'  .';;,','....  .cxOKXXXXXKOxc.     .:lxk:,dKXXX0olxkc,:odxdoolll:.  ..  ##
##    .,'...    .ckXXXXXXKd.   ',,,'....  'lOXXXXNXXXXXXXXOl;;:o0XKxdxOKXXXXXKo,;odddddk0Ol;'.       ##
##    .'''''..    .:xkKXXX0c.  ..'...   .l0XXXXXXXXXXXXXXXXXXXXXXXk;dX0k0XXXXXKo...,ckKX00k;.        ##
##  ..  ....         .,xXXXKx:.  ...   ,o0XXXXXXXXXXXXK0XXXXXXXXXX0xoxOKXXXXXXXO:   .lkx;',;:.';.    ##
##      '::;.....,::;. 'dKXXXKx'  .. .c0XXXXXXXXXXXX0xdx0XXXXXXXXXXX0c;dKXXK0Ox;      .  .o0O:c0o    ##
##     .cxKKOkkkOKXXKx' .o0XXXXOl. .;d0XXNXXXXXXXXOol:clx0kOXXXXXXXKxclOKXkc;lxo'   .'.  cK0dcc;.    ##
##       .',,cdkKXXXXXk, .l0XXXXKc.:OXXXXXXXXXKOdd:... .,lccdoc::;,'.,k0x:..dKXXk,  ... .dx:,'.      ##
##    ...    . .';ok0KXOc..l0XXXOcc0XXXXXXXKxoodOKk;    ...'..''...   ...  .c0XXXk,   'ldl.          ##
##    ';;;.  ..  ....;cdOx,.c0XKOkKXXXXK0Oxdxkkkdc,.  .''...........         ;OXXXk,'oOk;    ..   .  ##
##  ., ';;:'  ..'.''..   'ldlcox0XXXXK0kdoldOkc'.       ...'..............     ;xKXKddkc.    ..      ##
##    .;'.'.  .,,''',,.   .ck0kdddddodxxl,..........    ..,;;,'',,,'.......    .,d0x:. .'::'...      ##
##    .'':c.. .',;;,,,,..   .cdxddddddl.   .';;,',''.    ..',;;;,''''''......     ..  .'''..':. :    ##
##    .. .....  .''.....''.     ';;,.       .',,'....       ..','.........      ..  .'''',,..;.      ##
##               ...........                  .....           ...     ..        ..  ..........     . ##
##                             .,::..                                                          .     ##
##                                                                                                   ##
##---------------------------------------------------------------------------------------------------##
##                                                                                                   ##
##  Open issues:                                                                                     ##
##                                                                                                   ##
##  -- Shadow depth bug --                                                                           ##
##   When an entity has a z-level > 0 and floats above ground, its shadow gets drawn in front of     ##
##   foreground objects. No idea why.                                                                ##
##                                                                                                   ##
##   Possible workaround: draw shadows as separate entities instead of having them be an attribute   ##
##   of other entities. Might be worse for performance!                                              ##
##                                                                                                   ##
##                                                                                                   ##
#######################################################################################################


# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
#                                                                                     #
# '|.   '|'                                                                           #
#  |'|   |   ....   .. .. ..     ....   ....  ... ...   ....     ....    ....   ....  #
#  | '|. |  '' .||   || || ||  .|...|| ||. '   ||'  || '' .||  .|   '' .|...|| ||. '  #
#  |   |||  .|' ||   || || ||  ||      . '|..  ||    | .|' ||  ||      ||      . '|.. #
# .|.   '|  '|..'|' .|| || ||.  '|...' |'..|'  ||...'  '|..'|'  '|...'  '|...' |'..|' #
#                                              ||                                     #
#                                             ''''                                    #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #

import  cProfile
import	random
import	pygame
import	tcod 		as rogue
import	constants	as C
import	assets 		as A
import	map_data 	as MAPS

from	pygame.locals import *


# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
#                                                                                 #
#   ..|'''.|                           .                              .           #
# .|'     '    ...   .. ...    ....  .||.  ... ..  ... ...    ....  .||.   ....   #
# ||         .|  '|.  ||  ||  ||. '   ||    ||' ''  ||  ||  .|   ''  ||   ||. '   #
# '|.      . ||   ||  ||  ||  . '|..  ||    ||      ||  ||  ||       ||   . '|..  #
#  ''|....'   '|..|' .||. ||. |'..|'  '|.' .||.     '|..'|.  '|...'  '|.' |'..|'  #
#                                                                                 #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #


class obj_block:
	'''
	A map block. Has x/y/z-coords and a name. Can be passable or impassable.
	'''
	
	def __init__(self, x, y, z, name, passable = True):
		
		self.x = x
		self.y = y
		self.z = z
		
		self.name = name
		
		self.passable = passable


class obj_entity:
	'''
	Basic game entity. Has a sprite, x/y/z-coords. Can have a shadow asset.
	Can have a creature component.
	'''
	
	def __init__(self, sprite, x, y, z, creature = None, shadow = None):
		
		self.sprite = sprite
		self.x = x
		self.y = y
		self.z = z
		self.creature = creature
		self.shadow = shadow
		
		if creature:
			self.creature.owner = self


class com_creature:
	'''
	Creature component. Can move. Has a name.
	'''	
	
	def __init__(
		self, 
		name):
	
		self.name = name
	
	def move(self, dx, dy, dz):
		
		try:
			ceiling = self.owner.z + dz == len(BLOCKLIST)-1 or self.owner.z + dz < 0
			path_free = BLOCKLIST[(self.owner.z+1)+dz][self.owner.y+dy][self.owner.x+dx].passable
		except IndexError:
			path_free = False
			
		if path_free:
			if self.owner.x + dx >= 0:
				self.owner.x += dx
			if self.owner.y + dy >= 0:
				self.owner.y += dy
			if not ceiling:
				self.owner.z += dz
				
				
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
#                                                                             #
# '||''|.                         '||                   ||                    #
#  ||   ||    ....  .. ...      .. ||    ....  ... ..  ...  .. ...     ... .  #
#  ||''|'   .|...||  ||  ||   .'  '||  .|...||  ||' ''  ||   ||  ||   || ||   #
#  ||   |.  ||       ||  ||   |.   ||  ||       ||      ||   ||  ||    |''    #
# .||.  '|'  '|...' .||. ||.  '|..'||.  '|...' .||.    .||. .||. ||.  '||||.  #
#                                                                    .|....'  #
#                                                                             #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #


class obj_Camera:
	'''
	The camera object. Moves the viewport around.
	'''
	
	def __init__(self, target):
		
		self.width  = C.CAMERA_WIDTH
		self.height = C.CAMERA_HEIGHT
		self.target = target
		
		e_cartesian_x = target.x * C.TILE_WIDTH
		e_cartesian_y = target.y * C.TILE_HEIGHT
		
		e_isometric_x = e_cartesian_x - e_cartesian_y
		e_isometric_y = ((e_cartesian_x + e_cartesian_y) / 4 * 2) - target.z * C.TILE_HEIGHT
		
		e_centered_x  = SURFACE_MAP.get_rect().centerx    + e_isometric_x + (C.TILE_WIDTH/2)
		e_centered_y  = SURFACE_MAP.get_rect().centery /2 + e_isometric_y + (C.TILE_HEIGHT/2)
		
		target_x = e_centered_x
		target_y = e_centered_y
		
		self.x, self.y = (target_x, target_y)
		
	def update(self):
		
		e_cartesian_x = self.target.x * C.TILE_WIDTH
		e_cartesian_y = self.target.y * C.TILE_HEIGHT
		
		e_isometric_x = e_cartesian_x - e_cartesian_y
		e_isometric_y = ((e_cartesian_x + e_cartesian_y) / 4 * 2) - PC.z * C.TILE_HEIGHT
		
		e_centered_x  = SURFACE_MAP.get_rect().centerx    + e_isometric_x + (C.TILE_WIDTH/2)
		e_centered_y  = SURFACE_MAP.get_rect().centery /2 + e_isometric_y + (C.TILE_HEIGHT/2)
		
		target_x = e_centered_x 
		target_y = e_centered_y 
		
		dx, dy = self.distance_map((target_x, target_y))
		
		self.x += int(dx * C.TRACKING_SPEED)
		self.y += int(dy * C.TRACKING_SPEED)
		
	def distance_map(self, coordinates):
		
		incoming_x, incoming_y = coordinates
		
		distance_x = incoming_x - self.x
		distance_y = incoming_y - self.y
		
		return (distance_x, distance_y)
	
	def distance_camera(self, coordinates):
		
		window_x, window_y = coordinates
		
		distance_x = window_x - (self.width//2)
		distance_y = window_y - (self.height//2)
		
		return (distance_x, distance_y)
	
	def convert_coordinates(self, coordinates):
		
		target_x, target_y = coordinates
		
		camera_dx, camera_dy = self.distance_camera((target_x, target_y))

		map_x = self.x + camera_dx
		map_y = self.y + camera_dy
		
		return((map_x, map_y))
		
	@property
	def rectangle(self):
		
		pos_rectangle = pygame.Rect((0, 0), (C.CAMERA_WIDTH, C.CAMERA_HEIGHT))
	
		pos_rectangle.center = (self.x, self.y)
		
		return pos_rectangle
		
	@property
	def map_address(self):
		
		map_x = self.x / C.TILE_WIDTH
		map_y = self.y / C.TILE_HEIGHT
		
		return (map_x, map_y)


def draw_text(
		display_surface,
		text_to_display,
		T_coordinates,
		text_color,
		font = A.DEBUG_FONT,
		back_color = None):
	'''
	Display text in a specific color on the referenced surface.
	'''
	
	# get a handleable text surface
	text_surface, text_rect = helper_text_objects(text_to_display, text_color, font, back_color, )
	# make a box to draw it on
	text_rect.topleft = T_coordinates
	# draw it
	display_surface.blit(text_surface, text_rect)


def helper_text_objects(incoming_text, incoming_color, incoming_font, incoming_bg_color,):
	
	if incoming_bg_color:
		Text_surface = incoming_font.render(incoming_text, False, incoming_color, incoming_bg_color)
	else:
		Text_surface = incoming_font.render(incoming_text, False, incoming_color)
			
	return Text_surface, Text_surface.get_rect()


def helper_text_height(font):

	font_object = font.render('a', False, (0, 0, 0))
	font_rect = font_object.get_rect()

	return font_rect.height

	
def helper_text_width(font):
	
	font_object = font.render('a', False, (0, 0, 0))
	font_rect = font_object.get_rect()

	return font_rect.width
		

def tile_asset(tile):
	'''
	Takes in a tile from map data and returns the corresponding asset.
	'''
	
	## TODO: Make tile converter
	# All of these are placeholders! 
	if tile == 0: return TESTTILES[2]
	if tile == 1: return TESTTILES[3]
	if tile == 2: return TESTTILES[5]
	if tile == 3: return TESTTILES[3]
	if tile == 4: return TESTTILES[1]
	# # # # # # # # # # # # # # # # #


def game_render(map_data, map_bg = None):
	'''
	Takes in map data (expressed as [z-layer[row[tile]]]) and blits the corresponding asset to the display surface. 
	Also checks if there's an entity on the tile, and if yes, blits its assets to the current render location. 
	'''
	
	
	# set indices to 0 so rendering starts at the first z-level, row and tile each frame
	currentLevel = 0
	currentRow   = 0 
	currentTile  = 0 
	dist_to_ground = 0
	
	# fill main surface with black
	DISPLAYSURF.fill((0,0,0))
	
	# blit background image if one is passed, otherwise fill map surface with black
	if map_bg:
		SURFACE_MAP.blit(map_bg, (0,0))
	else:
		SURFACE_MAP.fill((0,0,0))
	
	# for each z-level of the map...
	for level in map_data:

		# reset row index when a z-level is done
		currentRow = 0
		
		# for each row along the y-axis...
		for row in level:
		
			# only render rows within y-axis render range
			## TODO: Tie render range to camera target instead of player character
			if currentRow in range(int(PC.y-C.RENDER_SIZE-1), int(PC.y+C.RENDER_SIZE+3)):
			
				# for each tile along the x-axis...
				for tile in row:
					
					# only render rows within x-axis render range
					## TODO: Tie render range to camera target instead of player character
					if currentTile in range(int(PC.x-C.RENDER_SIZE-1),int(PC.x+C.RENDER_SIZE+1)):
				
						# Cartesian coords
						cartesian_x = currentTile * C.TILE_WIDTH
						cartesian_y = currentRow  * C.TILE_HEIGHT
						
						# Conversion to iso coords
						isometric_x =   cartesian_x - cartesian_y
						isometric_y = ((cartesian_x + cartesian_y) / 4 * 2) - currentLevel * C.TILE_HEIGHT
		
						# Ensures that everything gets rendered in the screen center
						centered_x = SURFACE_MAP.get_rect().centerx     + isometric_x
						centered_y = SURFACE_MAP.get_rect().centery / 2 + isometric_y
						
						# if there's a tile at the current location, blit the corresponding asset
						if tile != None: SURFACE_MAP.blit(tile_asset(tile), (centered_x, centered_y))
						
						# for all loaded entities...
						for entity in MASTERLIST:
							
							
							# is there an entity on the x/y/z-location we're currently rendering?
							if entity.x == currentTile and entity.y == currentRow and entity.z  == currentLevel - 1 :
								
								# Convert Cartesian coords to iso coords, center them
								e_cartesian_x = currentTile * C.TILE_WIDTH
								e_cartesian_y = currentRow * C.TILE_HEIGHT
								e_isometric_x = e_cartesian_x - e_cartesian_y
								e_isometric_y = ((e_cartesian_x + e_cartesian_y) / 4 * 2) - currentLevel * C.TILE_HEIGHT
								e_centered_x = SURFACE_MAP.get_rect().centerx     + e_isometric_x + (C.TILE_WIDTH  / 2)
								e_centered_y = SURFACE_MAP.get_rect().centery / 2 + e_isometric_y + (C.TILE_HEIGHT / 2)
								
								# reset height index for each entity
								dist_to_ground = 0
								
								# does the entity have a shadow attached?
								if entity.shadow:
					
									# iterate through the z-column, track empty spaces between entity and ground
									for i in range(0, len(map_data)):
										if map_data[currentLevel - i][currentRow][currentTile] == None: dist_to_ground += 1
									
									# generate the proper offset for the shadow
									z_offset = len(map_data) - dist_to_ground
									
									# blit shadow asset
									## TODO: Fix shadow depth bug
									
									
									SURFACE_MAP.blit(entity.shadow, (e_centered_x, e_centered_y + ((entity.z - z_offset) * C.TILE_HEIGHT)))
								
									
									
								# blit entity asset
								SURFACE_MAP.blit(entity.sprite, (e_centered_x, e_centered_y))
								
								
								
								
							
					# advance tile index
					currentTile += 1
						
			# reset tile index, advance row index
			currentTile = 0 
			currentRow += 1
			
		# when all rows are done, advance z-level index
		currentLevel += 1
	
	# blit area of the map surface that's in the camera area to main surface
	DISPLAYSURF.blit(SURFACE_MAP, (0, 0), CAMERA.rectangle)
	
	# blit UI surface to main surface
	DISPLAYSURF.blit(SURFACE_UI, (0,0))
	# update the camera
	CAMERA.update()


# # # # # # # # # # # # # # # # # # # # # # # # # # # #	
#                                                     #
# .|'''.|                    .                        #
# ||..  '  .... ...  ....  .||.    ....  .. .. ..     #
#  ''|||.   '|.  |  ||. '   ||   .|...||  || || ||    #
#.     '||   '|.|   . '|..  ||   ||       || || ||    #
#|'....|'     '|    |'..|'  '|.'  '|...' .|| || ||.   #
#          .. |                                       #
#           ''                                        #
# # # # # # # # # # # # # # # # # # # # # # # # # # # #


def parse_map(map_data):
	'''
	Reads map data and generates blocks.
	'''
	
	list_tiles = []
	list_row = []
	list_level = []
	
	# set indices to 0 so parsing starts at the first z-level, row and tile
	currentLevel = 0
	currentRow   = 0 
	currentTile  = 0 
	
	for z_level in map_data:
		
		# when a z-level is done, reset row index
		currentRow = 0
		
		for row in z_level:
			
			for tile in row:
				
				if tile == 0:
					block = obj_block(currentTile, currentRow, currentLevel, "Stone", passable = False)
				if tile == 1:
					block = obj_block(currentTile, currentRow, currentLevel, "Bricks", passable = False)
				if tile == 2:
					block = obj_block(currentTile, currentRow, currentLevel, "Green stone", passable = False)
				if tile == 3:
					block = obj_block(currentTile, currentRow, currentLevel, "Stone", passable = False)
				if tile == 4:
					block = obj_block(currentTile, currentRow, currentLevel, "Sand", passable = False)
				if tile == None:
					block = obj_block(currentTile, currentRow, currentLevel, "Nothing")
					
				list_tiles.append(block)
				
				# advance tile index
				currentTile += 1
				
			# reset tile index and advance row index
			list_row.append(list_tiles)
			list_tiles = []
			currentTile = 0
			currentRow += 1	
		
		list_level.append(list_row)
		list_row = []
				
		# when all rows are done, advance z-level index
		currentLevel += 1
	
	return list_level

def game_init():
	'''
	Starts a new game.
	'''

	global DISPLAYSURF, FPSCLOCK, GAME_RUNNING, MASTERLIST, PC, SURFACE_MAP, CAMERA, SURFACE_UI, BLOCKLIST, TESTTILES, testbg
	
	# Pygame init
	pygame.init()
	pygame.key.set_repeat(C.KEY_REPEAT_THRESH, C.KEY_REPEAT_SPEED)
	pygame.display.set_caption('RED SAND v0.0.0.1')
	DISPLAYSURF = pygame.display.set_mode((C.WINDOW_WIDTH, C.WINDOW_HEIGHT), DOUBLEBUF)
	SURFACE_MAP =  pygame.Surface((C.MAP_W, C.MAP_H))
	SURFACE_UI = pygame.Surface((C.WINDOW_WIDTH, 32))
	FPSCLOCK = pygame.time.Clock()
	
	# Game states
	GAME_RUNNING = True
	MASTERLIST = []

	# # # # TESTING & DEBUG # # # # # # # # # # # # # # #
	PC = obj_entity(A.char_1.convert_alpha(), 5, 5, 0, com_creature("Player"), A.shadow_small.convert_alpha())  
	MASTERLIST.append(PC)                                                    
	# # # # # # # # # # # # # # # # # # # # # # # # # # #
	
	BLOCKLIST = parse_map(MAPS.map_1)
	CAMERA = obj_Camera(PC)
	testbg = A.bg_1.convert()
	
	
	TESTTILES = [
	    A.red_sand.convert_alpha(),
	   A.red_sand2.convert_alpha(),
	       A.floor.convert_alpha(),
	        A.wall.convert_alpha(),
	       A.grass.convert_alpha(),
	  A.unexplored.convert_alpha(),
	A.floor_shadow.convert_alpha()
	]
	
def get_input():
	'''
	Handles player input.
	'''
	
	for event in pygame.event.get():
		
		# # # # # # # # #
		# System events #
		# # # # # # # # #
		
		
		# quit game via closing the window
		if event.type == QUIT:
			game_quit()

			
		# # # # # # # #
		# Keypresses  #
		# # # # # # # #
		
		 
		if event.type == KEYDOWN:
	
		# quit game via escape key
			if event.key == K_ESCAPE:
				game_quit()
		
		# movevement
		
			if event.key == K_SPACE:
				WUT = True
			
			# up
			if event.key == K_UP:
				PC.creature.move(0,-1, 0)
			
			# down
			if event.key == K_DOWN:
				PC.creature.move(0,1,0)
				
			# left
			if event.key == K_LEFT:
				PC.creature.move(-1,0,0)
				
			# right
			if event.key == K_RIGHT:
				PC.creature.move(1,0,0)
				
			# z-level up
			if event.key == K_PAGEUP:
				PC.creature.move(0,0,1)
			
			# z-level down
			if event.key == K_PAGEDOWN:
				PC.creature.move(0,0,-1)


def game_quit():
	'''
	Handles quitting the game.
	'''
	
	global GAME_RUNNING
	
	GAME_RUNNING = False
	
	pygame.quit()


def debug():
	'''
	Displays debug info.
	'''

	SURFACE_UI.fill((30,0,0))
	draw_text(SURFACE_UI, "Player X/Y/Z: " + str(PC.x) + "/" + str(PC.y) + "/" + str(PC.z), (5, 0), (255,255,255), back_color = (0,0,0))
	
	
	FPS_count = int(FPSCLOCK.get_fps())
	if FPS_count <= C.FPS_TARGET - (C.FPS_TARGET / 3):
		draw_text(SURFACE_UI, "FPS: " + str(FPS_count) + "/" + str(C.FPS_TARGET), (5, 16), (255,0,0), back_color = (0,0,0))		
	else:
		draw_text(SURFACE_UI, "FPS: " + str(FPS_count) + "/" + str(C.FPS_TARGET), (5, 16), (255,255,255), back_color = (0,0,0))
		
	

# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
#                                                                     #
# '||    ||'          ||              '||                             #
#  |||  |||   ....   ...  .. ...       ||    ...     ...   ... ...    #
#  |'|..'||  '' .||   ||   ||  ||      ||  .|  '|. .|  '|.  ||'  ||   #
#  | '|' ||  .|' ||   ||   ||  ||      ||  ||   || ||   ||  ||    |   #
# .|. | .||. '|..'|' .||. .||. ||.    .||.  '|..|'  '|..|'  ||...'    #
#                                                           ||        #
#                                                          ''''       #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #


def main():
	'''
	The main loop. Everything gets called from here.
	'''
	
	while GAME_RUNNING:
		
		game_render(MAPS.map_1, testbg)
		
		FPSCLOCK.tick(C.FPS_TARGET)
		
		pygame.display.update()
		
		debug()
		
		get_input()
		
	pygame.display.quit()


# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
#                                                             #
# '||''|.                       .    ||                       #
#  ||   ||  ... ...  .. ...   .||.  ...  .. .. ..     ....    #
#  ||''|'    ||  ||   ||  ||   ||    ||   || || ||  .|...||   #
#  ||   |.   ||  ||   ||  ||   ||    ||   || || ||  ||        #
# .||.  '|'  '|..'|. .||. ||.  '|.' .||. .|| || ||.  '|...'   #
#                                                             #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #


if __name__ == '__main__':
	
	game_init()
	main()

	
#########################################################################################################
##                                                                                                     ##
##                --.--|                            |                                                  ##
##                  |  |---.,---.    ,---.,---.,---.|---         ,---.,---.,---.,---.                  ##
##                  |  |   ||---'    |   |,---|`---.|            |   ||   ||   ||---'                  ##
##                  `  `   '`---'    |---'`---^`---'`---' |      `---|`---'`   '`---'o                 ##
##                                   |                   '       `---'                                 ##
##                                                                                                     ##
##           --.--|             ,---.     |                               |              |             ##
##             |  |---.,---.    |__. .   .|--- .   .,---.,---.        ,---|,---.,---.,---|             ##
##             |  |   ||---'    |    |   ||    |   ||    |---'        |   ||---',---||   |             ##
##             `  `   '`---'    `    `---'`---'`---'`    `---' |      `---'`---'`---^`---'o            ##
##                                                            '                                        ##
##  .                                                                                                  ##
##  .     .  ..   ...',,,'...    ..... ..                                 ........                     ##
##      .'...''.  'ld0Kkdl:co:.  ..''..,;'..,clllllc,.....            ....';;;,,'. .;lll,.,clllc'      ##
##       ...      ;ddkdlcccck0o. ,llokKK00KKKXXXXXXXKKKKK0dlc,.....   ...','''..   .o0XXKKKXX0d,.      ##
##      ':'.      'ccokkxkdldo,:d0XXXXXXXXXXXXXXXXXXXXXXXXXX0kkOOOxl:'   ..,,,,'.    ,dKXXXOl'...      ##
##    'oxc.  .'.  .'ckkdkKXOd;,kXXXXXXXXKO0XXXXXXXXXXXXXXXXXXXXXXXXXX0o,   .';,.     'xKXXx'  .cc.     ##
##   .xKd.    ...   .;'cKXXXX0kKXXXXXXXkcd0XXXXXX0OKXXXXXXXXXXXXXXXXXXX0xd:.        .lKXXXo.  .;,.     ##
##    ;d0kc'......  .cocoxk0xoOK0KXXXXXOolOXNXXX0olOXXXXXXXXXXXXXXXXXXXXXXXOc.      :KXXXXo.   ..      ##
##      'oO000xlllc,..;:cdOO:..,',dKXXXXk;,cd00o,;xKKKKKKKKKXXKXXXXXXXXXXXXXX0o'.   cKXXXXo.  ...      ##
##       .;lokKXXNXKkxc,:oo;.     .o0XXXKx'  ..   '::,cdo:cOXKkdkKXXXXXXXXXXXXX0kd:.cKXXXXO;  .,'.     ##
##  .     .  .:dxxO0kxddxxd:.   .  .l0XXXXk,   ..  .cxOXKxcd0O0kc:xKXXXXXXXXXXXXXNXklo0XXXNk.  ..      ##
##         ..     ,odx0XK0KKkdooo:'..dXXXXKc  .'. .c0XXXX0lclcoc..,lxk0XNXXXXXXXXXXXOdxKXNXk. .'.      ##
##  .      .'.  .;oOKOoc,':ldO0XXXKOook0XXKo. ... ,kXXXXXXOlc:,;cdO0d:;lkKXXXXXXXXXXXXKXXXXk.  .       ##
##  .       .. .lo,:d,   ......cOXXXX0kkKXXKl.   ,kXXXXOdoooxO0KXXXXKd' .;ld0KXXXXXXXXXXXXO:.          ##
##  .       ...... ...    .''.  .:ox0XXXXXXO;   ,kXXXKdcdk0XXXXXXX0d;...   .;:loox0XXXXXKk;......      ##
##  .     .  .''.';;,,'    ..'..    .,,cxkx;    cKXXXXOOKXXXXXXX0o'  .''''''';,.  ,okkd:'.  .';'       ##
##      .:l,   ..',,'......   ........          ;OXXXXXXXXXXKOkl.   ..'.....,,,..           .,cl'      ##
##       .'.    ....   .;c,.    .....      ..    'cok0000Odl;..     ........'''..   .. ...''',;'.      ##
##  .                   ...                         ......                          .. .. .....     .  ##
##  ....                                                       .                   .   ..   .  ... ..  ##
##                                                                                                     ##
#########################################################################################################